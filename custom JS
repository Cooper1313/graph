<script>
    const form = document.getElementById('graph-form');
    const apiKeyInput = document.getElementById('api-key');
    const imageUploadInput = document.getElementById('image-upload');
    const graphDescriptionTextarea = document.getElementById('graph-description');
    const copyButton = document.getElementById('copyButton');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        const apiKey = apiKeyInput.value;
        const imageFile = imageUploadInput.files[0];

        if (!apiKey || !imageFile) {
            alert('Please enter an API key and upload an image.');
            return;
        }

        // Check if the file is an image (PNG, JPG, JPEG, GIF)
        if (!imageFile.type.startsWith('image/')) {
            alert('Please upload a valid image file (PNG, JPG, JPEG, GIF).');
            return;
        }

        const reader = new FileReader();
        reader.onload = async function(e) {
            const imageData = e.target.result; // Base64 encoded image data
            const prompt = `Describe the following graph in a way that is accessible to people using screen readers. Provide a concise and informative alt text description.  The graph is represented as a base64 encoded image: ${imageData}`;

            try {
                const response = await fetch('https://api.ai.it.ufl.edu/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "navigator",
                        messages: [{"role": "user", "content": prompt}]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Full API Response:", data); // Log the entire response

                // Check the structure of the response and adjust accordingly
                try {
                    graphDescriptionTextarea.value = data.choices[0].message.content;
                } catch (error) {
                    console.error("Error parsing response:", error);
                    graphDescriptionTextarea.value = "Error: Could not parse API response. Check the console for details.";
                }

            } catch (error) {
                console.error('Error calling API:', error);
                graphDescriptionTextarea.value = 'Error processing the image: ' + error.message;
            }
        };
        reader.readAsDataURL(imageFile); // Read the image file as a data URL (Base64)
    });

    copyButton.addEventListener('click', function() {
        graphDescriptionTextarea.select();
        document.execCommand('copy');
        alert('Alt text copied to clipboard!');
    });
</script>
